name: 🚀 Deploy Workers

on:
  push:
    branches: [main]
    paths-ignore: ['README.md']

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: 🔄 Checkout code
      uses: actions/checkout@v4

    - name: ⎔ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'pnpm'

    - name: 📦 Install pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8
        run_install: |
          - args: [--global, wrangler]
          - args: [add, -D, typescript]

    - name: 🧩 Install dependencies
      run: |
        pnpm install
        pnpm add dns-packet@5.6.1 ip-address@9.0.5 jsrsasign@10.6.0 semver@7.6.0

    - name: ⚙️ Configure Wrangler
      env:
        DATABASE_NAME: ${{ secrets.DATABASE_NAME }}
        DATABASE_ID: ${{ secrets.DATABASE_ID }}
        BEARER_TOKEN: ${{ secrets.BEARER_TOKEN }}
        D_TOKEN: ${{ secrets.D_TOKEN }}
      run: |
        sed -i "s|substore_workers_database_name|$DATABASE_NAME|g" wrangler.toml
        sed -i "s|substore_workers_database_id|$DATABASE_ID|g" wrangler.toml
        sed -i "s|substore_workers_bearer_token|$BEARER_TOKEN|g" wrangler.toml
        sed -i "s|substore_workers_d_token|$D_TOKEN|g" wrangler.toml
        echo -e "\nnode_compat = true" >> wrangler.toml
        echo -e "compatibility_date = \"$(date +%Y-%m-%d)\"" >> wrangler.toml

    - name: 🚀 Deploy
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      run: |
        pnpm exec wrangler deploy
